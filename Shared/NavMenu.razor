@inject ISpaSectionService SpaSections
@inject NavigationManager NavigationManager
@inject IAppDictionaryService AppDictionary

<RadzenPanelMenu class="app-nav-menu" DisplayStyle="@MenuItemDisplayStyle.IconAndText" Multiple="false">
    <RadzenPanelMenuItem Text="Home" Icon="home" Path="@GetHomePath()" />

    @foreach (var app in AppDictionary.GetAllApplications())
    {
        <RadzenPanelMenuItem Text="@app.Title" Icon="@(app.Icon ?? "apps")" Expanded="@IsActiveApp(app.Name)">
            @if (!string.IsNullOrEmpty(app.Url))
            {
                <RadzenPanelMenuItem Text="Open Application" Icon="open_in_new" Path="@app.Url" Target="_blank" />
            }
            @foreach (var sectionItem in SpaSections.GetSectionsForApplication(app.Name))
            {
                var sectionPath = GetSectionPath(app.Name, sectionItem);
                var sectionIcon = GetSectionIcon(sectionItem.Section);
                <RadzenPanelMenuItem Text="@sectionItem.NavLabel" Icon="@sectionIcon" Path="@sectionPath" />
            }
        </RadzenPanelMenuItem>
    }
</RadzenPanelMenu>

@code {
    private string GetHomePath()
    {
        var firstApp = AppDictionary.GetAllApplications().FirstOrDefault();
        return firstApp != null ? $"/{firstApp.Name}/dashboard" : "/";
    }

    private bool IsActiveApp(string appName)
    {
        var uri = new Uri(NavigationManager.Uri);
        var path = uri.AbsolutePath;

        return path.Equals($"/{appName}", StringComparison.OrdinalIgnoreCase)
            || path.StartsWith($"/{appName}/", StringComparison.OrdinalIgnoreCase);
    }

    private string GetSectionPath(string appName, SpaSectionInfo section)
    {
        return $"/{appName}/{section.RouteSegment}";
    }

    private static string GetSectionIcon(SpaSection section)
    {
        return section switch
        {
            SpaSection.Dashboard => "dashboard",
            SpaSection.Settings => "settings",
            SpaSection.Entity => "table_chart",
            SpaSection.View => "assessment",
            _ => "apps"
        };
    }
}
