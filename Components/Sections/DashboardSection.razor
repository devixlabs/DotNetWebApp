<RadzenStack Gap="20px">
    <RadzenRow Gap="20px">
        @foreach (var entityMeta in EntityMetadataService.Entities)
        {
            var displayName = entityMeta.Definition.Name;
            // Use schema-qualified key for lookup if schema exists
            var lookupKey = string.IsNullOrWhiteSpace(entityMeta.Definition.Schema)
                ? displayName
                : $"{entityMeta.Definition.Schema}:{displayName}";
            var count = entityCountsByName.GetValueOrDefault(lookupKey, 0);

            <RadzenColumn Size="12" Medium="6" Large="3">
                <RadzenCard>
                    <RadzenStack Gap="8px">
                        <RadzenText Text="@($"Total {displayName}s")" TextStyle="TextStyle.Subtitle2" />
                        @if (isLoading)
                        {
                            <RadzenText Text="Loading..." TextStyle="TextStyle.H5" />
                        }
                        else
                        {
                            <RadzenText Text="@count.ToString()" TextStyle="TextStyle.H4" />
                        }
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        }

        <RadzenColumn Size="12" Medium="6" Large="3">
            <RadzenCard>
                <RadzenStack Gap="8px">
                    <RadzenText Text="Revenue" TextStyle="TextStyle.Subtitle2" />
                    <RadzenText Text="@($"${summary.Revenue:N2}")" TextStyle="TextStyle.H4" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" Medium="6" Large="3">
            <RadzenCard>
                <RadzenStack Gap="8px">
                    <RadzenText Text="Active Users" TextStyle="TextStyle.Subtitle2" />
                    <RadzenText Text="@summary.ActiveUsers.ToString()" TextStyle="TextStyle.H4" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" Medium="6" Large="3">
            <RadzenCard>
                <RadzenStack Gap="8px">
                    <RadzenText Text="Growth" TextStyle="TextStyle.Subtitle2" />
                    <RadzenText Text="@($"+{summary.GrowthPercent}%")" TextStyle="TextStyle.H4" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenCard>
        <RadzenStack Gap="12px">
            <RadzenText Text="Recent Activity" TextStyle="TextStyle.Subtitle2" />
            <RadzenStack Gap="8px">
                @foreach (var activity in summary.RecentActivities)
                {
                    <RadzenStack Orientation="@Orientation.Horizontal" JustifyContent="@JustifyContent.SpaceBetween" AlignItems="@AlignItems.Center">
                        <RadzenText Text="@activity.When" TextStyle="TextStyle.Caption" />
                        <RadzenText Text="@activity.Description" />
                    </RadzenStack>
                }
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@inject IDashboardService DashboardService
@inject IEntityMetadataService EntityMetadataService

@code {
    private DashboardSummary summary = new();
    private bool isLoading = true;
    private IReadOnlyDictionary<string, int> entityCountsByName = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            summary = await DashboardService.GetSummaryAsync();
            entityCountsByName = summary.EntityCounts.ToDictionary(
                entityCount => entityCount.EntityName,
                entityCount => entityCount.Count,
                StringComparer.OrdinalIgnoreCase);
        }
        finally
        {
            isLoading = false;
        }
    }
}
