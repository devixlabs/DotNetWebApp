<RadzenStack Gap="20px">
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter" Style="margin-bottom: 1rem;">
            <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H4">Dashboard Load Error</RadzenText>
            <RadzenText>@errorMessage</RadzenText>
        </RadzenAlert>
    }

    <RadzenRow Gap="20px">
        @foreach (var entityMeta in EntityMetadataService.Entities)
        {
            var displayName = entityMeta.Definition.Name;
            // Use schema-qualified key for lookup if schema exists
            var lookupKey = string.IsNullOrWhiteSpace(entityMeta.Definition.Schema)
                ? displayName
                : $"{entityMeta.Definition.Schema}:{displayName}";
            var countInfo = summary.EntityCounts.FirstOrDefault(ec => ec.EntityName == lookupKey);
            var count = countInfo?.Count ?? 0;
            var hasError = countInfo?.HasError ?? false;
            var errorMsg = countInfo?.ErrorMessage;

            <RadzenColumn Size="12" Medium="6" Large="3">
                <RadzenCard>
                    <RadzenStack Gap="8px">
                        <RadzenText Text="@($"Total {displayName}s")" TextStyle="TextStyle.Subtitle2" />
                        @if (isLoading)
                        {
                            <RadzenText Text="Loading..." TextStyle="TextStyle.H5" />
                        }
                        else if (hasError)
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Size="AlertSize.Small" Style="margin-top: 0.5rem;">
                                <RadzenText TextStyle="TextStyle.Caption">@errorMsg</RadzenText>
                            </RadzenAlert>
                        }
                        else
                        {
                            <RadzenText Text="@count.ToString()" TextStyle="TextStyle.H4" />
                        }
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        }

        <RadzenColumn Size="12" Medium="6" Large="3">
            <RadzenCard>
                <RadzenStack Gap="8px">
                    <RadzenText Text="Revenue" TextStyle="TextStyle.Subtitle2" />
                    <RadzenText Text="@($"${summary.Revenue:N2}")" TextStyle="TextStyle.H4" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" Medium="6" Large="3">
            <RadzenCard>
                <RadzenStack Gap="8px">
                    <RadzenText Text="Active Users" TextStyle="TextStyle.Subtitle2" />
                    <RadzenText Text="@summary.ActiveUsers.ToString()" TextStyle="TextStyle.H4" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" Medium="6" Large="3">
            <RadzenCard>
                <RadzenStack Gap="8px">
                    <RadzenText Text="Growth" TextStyle="TextStyle.Subtitle2" />
                    <RadzenText Text="@($"+{summary.GrowthPercent}%")" TextStyle="TextStyle.H4" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenCard>
        <RadzenStack Gap="12px">
            <RadzenText Text="Recent Activity" TextStyle="TextStyle.Subtitle2" />
            <RadzenStack Gap="8px">
                @foreach (var activity in summary.RecentActivities)
                {
                    <RadzenStack Orientation="@Orientation.Horizontal" JustifyContent="@JustifyContent.SpaceBetween" AlignItems="@AlignItems.Center">
                        <RadzenText Text="@activity.When" TextStyle="TextStyle.Caption" />
                        <RadzenText Text="@activity.Description" />
                    </RadzenStack>
                }
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@inject IDashboardService DashboardService
@inject IEntityMetadataService EntityMetadataService

@code {
    private DashboardSummary summary = new();
    private bool isLoading = true;
    private string? errorMessage;
    private IReadOnlyDictionary<string, int> entityCountsByName = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

    [Parameter]
    public string AppName { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get app-specific dashboard if AppName provided
            if (!string.IsNullOrEmpty(AppName))
            {
                summary = await DashboardService.GetSummaryForApplicationAsync(AppName);
            }
            else
            {
                summary = await DashboardService.GetSummaryAsync();
            }

            entityCountsByName = summary.EntityCounts.ToDictionary(
                entityCount => entityCount.EntityName,
                entityCount => entityCount.Count,
                StringComparer.OrdinalIgnoreCase);
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("not found"))
        {
            errorMessage = $"Application '{AppName}' not found. Please check the application name and try again.";
        }
        catch (HttpRequestException)
        {
            errorMessage = "Could not load dashboard data. The server may be temporarily unavailable. Please try refreshing the page.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load dashboard: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
