@using DotNetWebApp.Models.UI
@using Microsoft.EntityFrameworkCore
@inject IEntityApiService EntityApiService
@inject IEntityMetadataService EntityMetadataService
@inject IEntityOperationService EntityOperationService
@inject NotificationService NotificationService
@inject ILogger<EntitySection> Logger
@inject DialogService DialogService

<RadzenCard>
    <RadzenStack Gap="16px">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
                @errorMessage
            </RadzenAlert>
        }
        else if (isLoading)
        {
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="8px">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                <RadzenText Text="Loading..." />
            </RadzenStack>
        }
        else if (entities != null && entities.Count > 0)
        {
            <SmartDataGridObject Data="@entities"
                                 AllowFiltering="true"
                                 AllowSorting="true"
                                 AllowPaging="true"
                                 AllowEdit="true"
                                 AllowDelete="true"
                                 ShowActionColumn="true"
                                 OnRowUpdate="@(new EventCallback<object>(this, HandleRowUpdate))"
                                 OnRowDelete="@(new EventCallback<object>(this, HandleRowDelete))"
                                 OnRowEdit="@(new EventCallback<object>(this, HandleRowEdit))" />
        }
        else
        {
            <RadzenText Text="No data available" TextStyle="TextStyle.Body2" />
        }
    </RadzenStack>
</RadzenCard>

@code {
    [Parameter]
    public string AppName { get; set; } = "admin";

    [Parameter]
    public string EntityName { get; set; } = string.Empty;

    private IReadOnlyList<object>? entities;
    private bool isLoading;
    private string? errorMessage;
    private EntityMetadata? entityMetadata;

    protected override async Task OnParametersSetAsync()
    {
        if (string.IsNullOrWhiteSpace(EntityName))
        {
            errorMessage = "Entity not specified.";
            return;
        }

        isLoading = true;
        errorMessage = null;
        entities = null;

        try
        {
            var metadata = EntityMetadataService.Find(EntityName);
            if (metadata == null)
            {
                errorMessage = $"Entity '{EntityName}' not found";
                return;
            }

            entityMetadata = metadata;

            // Use the qualified EntityName (e.g., "initech:Company") to ensure correct schema lookup
            var result = await EntityApiService.GetEntitiesAsync(AppName, EntityName);
            entities = result.ToList().AsReadOnly();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading entities for {EntityName}", EntityName);
            errorMessage = $"Error loading {EntityName}: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    /// <summary>
    /// Handles row update from SmartDataGrid
    /// </summary>
    private async Task HandleRowUpdate(object row)
    {
        if (entityMetadata?.ClrType == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Entity metadata not available",
                Duration = 4000
            });
            return;
        }

        try
        {
            Logger.LogInformation("Updating entity {EntityName}", EntityName);

            await EntityOperationService.UpdateAsync(entityMetadata.ClrType, row);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = "Record updated successfully",
                Duration = 3000
            });

            // Refresh the data
            await RefreshEntitiesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating entity {EntityName}", EntityName);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to update record: {ex.Message}",
                Duration = 4000
            });
        }
    }

    /// <summary>
    /// Handles row delete from SmartDataGrid
    /// Shows confirmation dialog before deleting
    /// </summary>
    private async Task HandleRowDelete(object row)
    {
        if (entityMetadata?.ClrType == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Entity metadata not available",
                Duration = 4000
            });
            return;
        }

        try
        {
            // Show confirmation dialog
            var confirmed = await DialogService.Confirm(
                "Are you sure you want to delete this record? This action cannot be undone.",
                "Confirm Delete",
                new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" });

            if (confirmed != true)
            {
                Logger.LogInformation("Delete cancelled for entity {EntityName}", EntityName);
                return;
            }

            Logger.LogInformation("Deleting entity {EntityName}", EntityName);

            // Get the primary key value
            var pkProperty = entityMetadata.Definition.Properties?
                .FirstOrDefault(p => p.IsPrimaryKey);

            if (pkProperty == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Primary key not defined",
                    Duration = 4000
                });
                return;
            }

            var pkValue = row.GetType()
                .GetProperty(pkProperty.Name)?
                .GetValue(row);

            if (pkValue == null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Could not extract primary key value",
                    Duration = 4000
                });
                return;
            }

            await EntityOperationService.DeleteAsync(entityMetadata.ClrType, pkValue);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = "Record deleted successfully",
                Duration = 3000
            });

            // Refresh the data
            await RefreshEntitiesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting entity {EntityName}", EntityName);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to delete record: {ex.Message}",
                Duration = 4000
            });
        }
    }

    /// <summary>
    /// Handles row edit from SmartDataGrid - opens modal dialog with form
    /// </summary>
    private async Task HandleRowEdit(object row)
    {
        if (entityMetadata?.ClrType == null)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Entity metadata not available",
                Duration = 4000
            });
            return;
        }

        try
        {
            Logger.LogInformation("Opening edit dialog for entity {EntityName}", EntityName);

            // Open Radzen modal dialog with EntityEditDialog component
            var result = await DialogService.OpenAsync<EntityEditDialog>(
                $"Edit {entityMetadata.Definition.Name}",
                new Dictionary<string, object>
                {
                    { "EntityMetadata", entityMetadata },
                    { "Entity", row }
                },
                new DialogOptions
                {
                    Width = "700px",
                    Height = "auto",
                    Resizable = true,
                    Draggable = true,
                    CloseDialogOnOverlayClick = false  // Prevent accidental closes
                }
            );

            // Check if user saved (result != null) or cancelled (result == null)
            if (result == null)
            {
                Logger.LogInformation("Edit cancelled for entity {EntityName}", EntityName);
                return;
            }

            Logger.LogInformation("Saving edited entity {EntityName}", EntityName);

            // Persist changes via EntityOperationService
            await EntityOperationService.UpdateAsync(entityMetadata.ClrType, result);

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = "Record updated successfully",
                Duration = 3000
            });

            // Refresh the entity list to show updated data
            await RefreshEntitiesAsync();
        }
        catch (DbUpdateConcurrencyException concEx)
        {
            Logger.LogWarning(concEx, "Concurrency conflict updating {EntityName}", EntityName);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Warning,
                Summary = "Concurrency Conflict",
                Detail = "Record was modified by another user. Refreshing data...",
                Duration = 5000
            });
            await RefreshEntitiesAsync();
        }
        catch (DbUpdateException dbEx)
        {
            Logger.LogError(dbEx, "Database error updating {EntityName}", EntityName);

            var innerMessage = dbEx.InnerException?.Message ?? dbEx.Message;
            var errorDetail = "Database error - please check your input and try again";

            if (innerMessage.Contains("FOREIGN KEY constraint"))
                errorDetail = "Cannot save - invalid reference to related data";
            else if (innerMessage.Contains("UNIQUE constraint"))
                errorDetail = "Cannot save - value must be unique";
            else if (innerMessage.Contains("cannot insert NULL"))
                errorDetail = "Cannot save - required field is missing";

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Database Error",
                Detail = errorDetail,
                Duration = 5000
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error updating {EntityName}", EntityName);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to update record: {ex.Message}",
                Duration = 5000
            });
        }
    }

    /// <summary>
    /// Refreshes the entity list after an operation
    /// </summary>
    private async Task RefreshEntitiesAsync()
    {
        try
        {
            isLoading = true;
            var result = await EntityApiService.GetEntitiesAsync(AppName, EntityName);
            entities = result.ToList().AsReadOnly();
            errorMessage = null;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing entities for {EntityName}", EntityName);
            errorMessage = $"Error refreshing data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
