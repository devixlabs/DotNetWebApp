@using DotNetWebApp.Models.AppDictionary
@inject IAppDictionaryService AppDictionary
@inject IEntityApiService EntityApi
@inject IEntityMetadataService EntityMetadataService

<RadzenCard>
    <RadzenStack Gap="16px">
        @* Header with controls *@
        <RadzenStack Orientation="@Orientation.Horizontal" AlignItems="@AlignItems.Center" JustifyContent="@JustifyContent.SpaceBetween">
            <RadzenText Text="@($"{EntityName} Management")" TextStyle="TextStyle.Subtitle2" />
            <RadzenStack Orientation="@Orientation.Horizontal" AlignItems="@AlignItems.Center" Gap="8px">
                <RadzenButton Click="Refresh" IsBusy="@isLoading"
                              Text="@(isLoading ? "Loading..." : "Refresh")"
                              Icon="refresh" ButtonStyle="ButtonStyle.Primary" />
                <RadzenButton Click="AddNewEntity" Text="@($"Add {EntityName}")" Icon="add"
                              ButtonStyle="ButtonStyle.Success" />
            </RadzenStack>
        </RadzenStack>

        @* Error handling *@
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
                @errorMessage
            </RadzenAlert>
        }
        else if (isLoading)
        {
            <RadzenStack Gap="12px" AlignItems="@AlignItems.Center">
                <RadzenProgressBar ProgressBarStyle="ProgressBarStyle.Primary" Value="100"
                                   ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                <RadzenText Text="@($"Loading {EntityName.ToLower()}...")" TextStyle="TextStyle.Body2" />
            </RadzenStack>
        }
        else if (data != null && entityType != null)
        {
            <DynamicDataGrid DataType="@entityType" Data="@data" />
        }
        else
        {
            <RadzenStack Gap="12px" AlignItems="@AlignItems.Center">
                <RadzenText Text="@($"No {EntityName.ToLower()} found.")" TextStyle="TextStyle.Body2" />
                <RadzenButton Click="Refresh" Text="@($"Load {EntityName}")" ButtonStyle="ButtonStyle.Primary" />
            </RadzenStack>
        }
    </RadzenStack>
</RadzenCard>

@code {
    [Parameter]
    public string EntityName { get; set; } = string.Empty;

    [Parameter]
    public EventCallback OnRefresh { get; set; }

    private Entity? entity;
    private Type? entityType;
    private IQueryable? data;
    private bool isLoading = false;
    private string? errorMessage;

    protected override async Task OnParametersSetAsync()
    {
        if (string.IsNullOrEmpty(EntityName))
            return;

        isLoading = true;
        errorMessage = null;

        try
        {
            // Get entity metadata
            var metadata = EntityMetadataService.Find(EntityName);
            if (metadata == null)
            {
                errorMessage = $"Entity '{EntityName}' not found";
                return;
            }

            entity = metadata.Definition;
            entityType = metadata.ClrType;

            // Fetch data
            var entities = await EntityApi.GetEntitiesAsync(EntityName);
            data = entities.AsQueryable();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading {EntityName}: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Refresh()
    {
        await OnRefresh.InvokeAsync();
        await OnParametersSetAsync();
    }

    private async Task AddNewEntity()
    {
        await Task.Delay(100);
        // TODO: Implement add new entity modal/form
    }
}
