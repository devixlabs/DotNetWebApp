@page "/app"
@page "/app/{Section?}"
@inject NavigationManager Navigation
@inject ISpaSectionService SpaSections
@inject IProductService ProductService

<PageTitle>DotNet SPA</PageTitle>

<RadzenRow Gap="20px" Style="min-height: calc(100vh - 140px);">
    <RadzenColumn Size="12">
        <RadzenStack Gap="20px">
            <SectionHeader Title="@SpaSections.GetInfo(activeSection).Title" IsLoading="@IsLoading" />

            @if (activeSection == SpaSection.Dashboard)
            {
                <DashboardSection />
            }
            else if (activeSection == SpaSection.Products)
            {
                <ProductsSection Products="@products" IsLoading="@IsLoading" OnRefresh="@LoadProducts" />
            }
            else if (activeSection == SpaSection.Settings)
            {
                <SettingsSection />
            }
        </RadzenStack>
    </RadzenColumn>
</RadzenRow>

@code {
    private SpaSection activeSection = SpaSection.Dashboard;
    private AsyncUiState? loadingState;
    private IReadOnlyList<Product>? products;

    private bool IsLoading => loadingState?.IsBusy == true;

    [Parameter] public string? Section { get; set; }

    protected override void OnInitialized()
    {
        loadingState = new AsyncUiState(() => InvokeAsync(StateHasChanged));
        activeSection = SpaSections.DefaultSection;
    }

    protected override async Task OnParametersSetAsync()
    {
        var requestedSection = SpaSections.FromRouteSegment(Section) ?? SpaSections.DefaultSection;
        await LoadSection(requestedSection);
    }

    private async Task LoadSection(SpaSection section)
    {
        if (activeSection == section && !IsLoading)
        {
            return;
        }

        activeSection = section;

        await loadingState!.RunAsync(async () =>
        {
            SpaSections.NavigateTo(section);

            if (section == SpaSection.Products)
            {
                await LoadProducts();
            }
            else
            {
                await Task.Delay(500);
            }
        });
    }

    private async Task LoadProducts()
    {
        products = await ProductService.GetProductsAsync();
    }
}
