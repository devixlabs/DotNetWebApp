@page "/"
@page "/{AppName}"
@page "/{AppName}/{*Section}"
@inject NavigationManager NavigationManager
@inject IAppDictionaryService AppDictionary
@inject ISpaSectionService SpaSections
@inject IEntityMetadataService EntityMetadataService

<PageTitle>DotNet Multi-App SPA</PageTitle>

<RadzenRow Gap="20px" Style="min-height: calc(100vh - 140px);">
    <RadzenColumn Size="12">
        <RadzenStack Gap="20px">
            @if (activeSection == null)
            {
                <RadzenCard>
                    <RadzenStack Gap="12px">
                        <RadzenText Text="No application selected." TextStyle="TextStyle.Subtitle1" />
                        <RadzenText Text="Please select an application from the menu." TextStyle="TextStyle.Body2" />
                    </RadzenStack>
                </RadzenCard>
            }
            else if (isEntitySection && activeEntityName != null)
            {
                <SectionHeader Title="@activeSection.Title" IsLoading="@false" />
                <EntitySection EntityName="@activeEntityName" />
            }
            else
            {
                <SectionHeader Title="@activeSection.Title" IsLoading="@IsLoading" />

                @if (activeSection.Section == SpaSection.Dashboard)
                {
                    <DashboardSection AppName="@AppName" />
                }
                else if (activeSection.Section == SpaSection.Settings)
                {
                    <SettingsSection />
                }
            }
        </RadzenStack>
    </RadzenColumn>
</RadzenRow>

@code {
    private static readonly HashSet<string> StaticPaths = new(StringComparer.OrdinalIgnoreCase)
    {
        "css", "js", "lib", "images", "_framework", "_blazor"
    };

    private SpaSectionInfo? activeSection;
    private string? activeEntityName;
    private bool isEntitySection => activeSection?.Section == SpaSection.Entity && activeEntityName != null;
    private AsyncUiState? loadingState;

    private bool IsLoading => loadingState?.IsBusy == true;

    [Parameter] public string? AppName { get; set; }
    [Parameter] public string? Section { get; set; }

    protected override void OnParametersSet()
    {
        loadingState = new AsyncUiState(() => InvokeAsync(StateHasChanged));

        // Handle root "/" route - redirect to first app
        if (string.IsNullOrEmpty(AppName))
        {
            var firstApp = AppDictionary.GetAllApplications().FirstOrDefault();
            if (firstApp != null)
            {
                NavigationManager.NavigateTo($"/{firstApp.Name}/dashboard", replace: true);
            }
            return;
        }

        // Skip static resource paths (let static file middleware handle)
        if (StaticPaths.Contains(AppName))
        {
            return;
        }

        // Validate AppName exists
        var app = AppDictionary.GetApplication(AppName);
        if (app == null)
        {
            // Invalid app, redirect to first app
            var firstApp = AppDictionary.GetAllApplications().FirstOrDefault();
            if (firstApp != null)
            {
                NavigationManager.NavigateTo($"/{firstApp.Name}/dashboard", replace: true);
            }
            return;
        }

        // Process section
        var segment = Section?.Trim();
        if (string.IsNullOrEmpty(segment))
        {
            // Default to dashboard
            activeSection = new SpaSectionInfo(SpaSection.Dashboard, "dashboard", "Dashboard", "dashboard");
            activeEntityName = null;
            return;
        }

        // Try to match static section first
        var section = SpaSections.FromRouteSegment(segment);
        if (section != null)
        {
            activeSection = section;
            activeEntityName = section.Section == SpaSection.Entity ? section.EntityName : null;
            return;
        }

        // Treat any non-static route segment as an entity name.
        // Convert URL format (schema/name) to internal format (schema:name) for metadata lookups
        var entityName = segment.Contains('/')
            ? segment.Replace('/', ':')
            : segment;
        activeSection = new SpaSectionInfo(SpaSection.Entity, segment, segment, segment, entityName);
        activeEntityName = entityName;
    }
}
