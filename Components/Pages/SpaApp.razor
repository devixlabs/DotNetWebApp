@page "/app"
@page "/app/{Section?}"
@using DotNetWebApp.Models.Generated
@inject NavigationManager Navigation
@inject ISpaSectionService SpaSections
@inject IEntityMetadataService EntityMetadataService

<PageTitle>DotNet SPA</PageTitle>

<RadzenRow Gap="20px" Style="min-height: calc(100vh - 140px);">
    <RadzenColumn Size="12">
        <RadzenStack Gap="20px">
            @if (isEntitySection && activeEntityName != null)
            {
                <SectionHeader Title="@activeEntityName" IsLoading="@false" />
                <EntitySection EntityName="@activeEntityName" />
            }
            else
            {
                <SectionHeader Title="@SpaSections.GetInfo(activeSection).Title" IsLoading="@IsLoading" />

                @if (activeSection == SpaSection.Dashboard)
                {
                    <DashboardSection />
                }
                else if (activeSection == SpaSection.Products)
                {
                    <EntitySection EntityName="Product" />
                }
                else if (activeSection == SpaSection.Settings)
                {
                    <SettingsSection />
                }
            }
        </RadzenStack>
    </RadzenColumn>
</RadzenRow>

@code {
    private SpaSection activeSection = SpaSection.Dashboard;
    private string? activeEntityName;
    private bool isEntitySection => activeEntityName != null;
    private AsyncUiState? loadingState;

    private bool IsLoading => loadingState?.IsBusy == true;

    [Parameter] public string? Section { get; set; }

    protected override void OnInitialized()
    {
        loadingState = new AsyncUiState(() => InvokeAsync(StateHasChanged));
        activeSection = SpaSections.DefaultSection;
    }

    protected override async Task OnParametersSetAsync()
    {
        var segment = Section?.Trim();
        if (string.IsNullOrEmpty(segment))
        {
            // Default to Dashboard
            activeSection = SpaSection.Dashboard;
            activeEntityName = null;
            return;
        }

        // Try to match static section first
        var staticSection = SpaSections.FromRouteSegment(segment);
        if (staticSection != null)
        {
            activeSection = staticSection.Value;
            activeEntityName = null;
            await LoadSection(staticSection.Value);
            return;
        }

        // Treat any non-static route segment as an entity name.
        activeSection = SpaSection.Dashboard;
        activeEntityName = segment;
    }

    private async Task LoadSection(SpaSection section)
    {
        if (activeSection == section && !IsLoading)
        {
            return;
        }

        activeSection = section;

        await loadingState!.RunAsync(async () =>
        {
            SpaSections.NavigateTo(section);
            await Task.Delay(500);
        });
    }

}
