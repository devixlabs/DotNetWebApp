@page "/app"
@page "/app/{*Section}"
@inject ISpaSectionService SpaSections
@inject IEntityMetadataService EntityMetadataService
@inject IOptions<AppCustomizationOptions> AppOptions

<PageTitle>DotNet SPA</PageTitle>

<RadzenRow Gap="20px" Style="min-height: calc(100vh - 140px);">
    <RadzenColumn Size="12">
        <RadzenStack Gap="20px">
            @if (!IsSpaEnabled)
            {
                <RadzenCard>
                    <RadzenStack Gap="12px">
                        <RadzenText Text="SPA example disabled." TextStyle="TextStyle.Subtitle1" />
                        <RadzenText Text="Enable AppCustomization:EnableSpaExample to use the /app routes." TextStyle="TextStyle.Body2" />
                    </RadzenStack>
                </RadzenCard>
            }
            else if (activeSection == null)
            {
                <RadzenCard>
                    <RadzenStack Gap="12px">
                        <RadzenText Text="No SPA sections are configured." TextStyle="TextStyle.Subtitle1" />
                        <RadzenText Text="Add entities to app.yaml or enable SPA sections in appsettings.json." TextStyle="TextStyle.Body2" />
                    </RadzenStack>
                </RadzenCard>
            }
            else if (isEntitySection && activeEntityName != null)
            {
                <SectionHeader Title="@activeSection.Title" IsLoading="@false" />
                <EntitySection EntityName="@activeEntityName" />
            }
            else
            {
                <SectionHeader Title="@activeSection.Title" IsLoading="@IsLoading" />

                @if (activeSection.Section == SpaSection.Dashboard)
                {
                    <DashboardSection />
                }
                else if (activeSection.Section == SpaSection.Settings)
                {
                    <SettingsSection />
                }
            }
        </RadzenStack>
    </RadzenColumn>
</RadzenRow>

@code {
    private SpaSectionInfo? activeSection;
    private string? activeEntityName;
    private bool isEntitySection => activeSection?.Section == SpaSection.Entity && activeEntityName != null;
    private AsyncUiState? loadingState;

    private bool IsLoading => loadingState?.IsBusy == true;
    private bool IsSpaEnabled => AppOptions.Value.EnableSpaExample;

    [Parameter] public string? Section { get; set; }

    protected override void OnInitialized()
    {
        loadingState = new AsyncUiState(() => InvokeAsync(StateHasChanged));
        activeSection = SpaSections.DefaultSection;
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!IsSpaEnabled)
        {
            activeSection = null;
            activeEntityName = null;
            return;
        }

        var segment = Section?.Trim();
        if (string.IsNullOrEmpty(segment))
        {
            // Default to the first SPA section.
            activeSection = SpaSections.DefaultSection;
            activeEntityName = null;
            return;
        }

        // Try to match static section first
        var section = SpaSections.FromRouteSegment(segment);
        if (section != null)
        {
            activeSection = section;
            activeEntityName = section.Section == SpaSection.Entity ? section.EntityName : null;

            if (section.Section != SpaSection.Entity)
            {
                await LoadSection(section);
            }
            return;
        }

        // Treat any non-static route segment as an entity name.
        // Convert URL format (schema/name) to internal format (schema:name) for metadata lookups
        var entityName = segment.Contains('/')
            ? segment.Replace('/', ':')
            : segment;
        activeSection = new SpaSectionInfo(SpaSection.Entity, segment, segment, segment, entityName);
        activeEntityName = entityName;
    }

    private async Task LoadSection(SpaSectionInfo section)
    {
        if (activeSection == section && !IsLoading)
        {
            return;
        }

        activeSection = section;

        await loadingState!.RunAsync(async () =>
        {
            SpaSections.NavigateTo(section);
            await Task.Delay(500);
        });
    }

}
