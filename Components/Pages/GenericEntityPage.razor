@page "/entity/{EntityName}"
@page "/entity/{Schema}/{EntityName}"
@inject IEntityApiService EntityApi
@inject IEntityMetadataService EntityMetadataService

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <p role="alert">@errorMessage</p>
}
else if (!string.IsNullOrWhiteSpace(EntityName))
{
    <h1>@DisplayName</h1>

    @if (entities != null)
    {
        <DynamicDataGrid Entities="@entities" EntityName="@QualifiedName" />
    }
}

@code {
    [Parameter]
    public string? Schema { get; set; }

    [Parameter]
    public string? EntityName { get; set; }

    private IReadOnlyList<object>? entities;

    private bool isLoading;
    private string? errorMessage;

    // Build schema-qualified name for API calls (e.g., "initech:Company")
    private string QualifiedName => string.IsNullOrWhiteSpace(Schema)
        ? EntityName ?? string.Empty
        : $"{Schema}:{EntityName}";

    // Display name shows schema in parentheses if present
    private string DisplayName => string.IsNullOrWhiteSpace(Schema)
        ? EntityName ?? string.Empty
        : $"{EntityName} ({Schema})";

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        errorMessage = null;
        entities = null;

        if (string.IsNullOrWhiteSpace(EntityName))
        {
            errorMessage = "Entity not specified.";
            isLoading = false;
            return;
        }

        var metadata = EntityMetadataService.Find(QualifiedName);
        if (metadata == null || metadata.ClrType == null)
        {
            errorMessage = $"No model type found for '{QualifiedName}'.";
            isLoading = false;
            return;
        }

        try
        {
            // Use schema-qualified name (e.g., "initech:Company") to ensure correct schema lookup
            var result = await EntityApi.GetEntitiesAsync(QualifiedName);
            entities = result.ToList().AsReadOnly();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load {DisplayName} data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}
