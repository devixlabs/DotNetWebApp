@* SmartDataGrid<T> - Generic configurable data grid with edit/delete capabilities *@
@typeparam T where T : class, new()
@using System.Reflection
@using Microsoft.AspNetCore.Components
@using Radzen
@using Radzen.Blazor
@using DotNetWebApp.Models.UI

@inject NotificationService NotificationService
@inject ILogger<SmartDataGrid<T>> Logger

<RadzenCard>
    <RadzenStack Gap="8px">
        @if (Data != null && Data.Any())
        {
            @if (AllowInlineEdit)
            {
                <RadzenDataGrid @ref="grid"
                               Data="@Data"
                               TItem="T"
                               EditMode="DataGridEditMode.Single"
                               RowUpdate="@OnRowUpdated"
                               RowCreate="@OnRowCreated"
                               AllowFiltering="@AllowFiltering"
                               AllowSorting="@AllowSorting"
                               AllowPaging="@AllowPaging"
                               PageSize="20"
                               Style="width: 100%;">

                <Columns>
                    @foreach (var column in GetColumnConfig())
                    {
                        @if (!column.Hidden)
                        {
                            @if (column.Editable && AllowInlineEdit)
                            {
                                <RadzenDataGridColumn TItem="T"
                                                     Property="@column.Property"
                                                     Title="@column.DisplayName"
                                                     FormatString="@column.FormatString"
                                                     Width="@(column.Width.HasValue ? $"{column.Width}px" : null)"
                                                     Sortable="@column.Sortable"
                                                     Filterable="@column.Filterable"
                                                     Editable="true" />
                            }
                            else
                            {
                                <RadzenDataGridColumn TItem="T"
                                                     Property="@column.Property"
                                                     Title="@column.DisplayName"
                                                     FormatString="@column.FormatString"
                                                     Width="@(column.Width.HasValue ? $"{column.Width}px" : null)"
                                                     Sortable="@column.Sortable"
                                                     Filterable="@column.Filterable" />
                            }
                        }
                    }

                    @if (ShowActionColumn)
                    {
                        <RadzenDataGridColumn TItem="T"
                                             Title="Actions"
                                             Sortable="false"
                                             Filterable="false"
                                             Width="120px"
                                             TextAlign="TextAlign.Center">
                            <Template Context="row">
                                @if (AllowEdit && !AllowInlineEdit)
                                {
                                    <RadzenButton Icon="edit"
                                                Size="ButtonSize.Small"
                                                Click="@(_ => OnEditRow(row))"
                                                ButtonStyle="ButtonStyle.Light"
                                                Class="me-1" />
                                }
                                @if (AllowDelete)
                                {
                                    <RadzenButton Icon="delete"
                                                Size="ButtonSize.Small"
                                                Click="@(_ => OnDeleteRow(row))"
                                                ButtonStyle="ButtonStyle.Danger"
                                                Class="ms-1" />
                                }
                            </Template>
                        </RadzenDataGridColumn>
                    }
                </Columns>
                </RadzenDataGrid>
            }
            else
            {
                <RadzenDataGrid @ref="grid"
                               Data="@Data"
                               TItem="T"
                               AllowFiltering="@AllowFiltering"
                               AllowSorting="@AllowSorting"
                               AllowPaging="@AllowPaging"
                               PageSize="20"
                               Style="width: 100%;">
                    <Columns>
                        @foreach (var column in GetColumnConfig())
                        {
                            @if (!column.Hidden)
                            {
                                <RadzenDataGridColumn TItem="T"
                                                     Property="@column.Property"
                                                     Title="@column.DisplayName"
                                                     FormatString="@column.FormatString"
                                                     Width="@(column.Width.HasValue ? $"{column.Width}px" : null)"
                                                     Sortable="@column.Sortable"
                                                     Filterable="@column.Filterable" />
                            }
                        }

                        @if (ShowActionColumn)
                        {
                            <RadzenDataGridColumn TItem="T"
                                                 Title="Actions"
                                                 Sortable="false"
                                                 Filterable="false"
                                                 Width="120px"
                                                 TextAlign="TextAlign.Center">
                                <Template Context="row">
                                    @if (AllowEdit && !AllowInlineEdit)
                                    {
                                        <RadzenButton Icon="edit"
                                                    Size="ButtonSize.Small"
                                                    Click="@(_ => OnEditRow(row))"
                                                    ButtonStyle="ButtonStyle.Light"
                                                    Class="me-1" />
                                    }
                                    @if (AllowDelete)
                                    {
                                        <RadzenButton Icon="delete"
                                                    Size="ButtonSize.Small"
                                                    Click="@(_ => OnDeleteRow(row))"
                                                    ButtonStyle="ButtonStyle.Danger"
                                                    Class="ms-1" />
                                    }
                                </Template>
                            </RadzenDataGridColumn>
                        }
                    </Columns>
                </RadzenDataGrid>
            }

            @if (Data != null)
            {
                <div style="font-size: 0.9em; color: #666; margin-top: 8px;">
                    Showing @Data.Count() records
                </div>
            }
        }
        else
        {
            <RadzenText Text="No data available" TextStyle="TextStyle.Body2" />
        }
    </RadzenStack>
</RadzenCard>

@code {
    /// <summary>
    /// Data to display in the grid
    /// </summary>
    [Parameter]
    public IEnumerable<T>? Data { get; set; }

    /// <summary>
    /// Enable filtering on columns (default: true)
    /// </summary>
    [Parameter]
    public bool AllowFiltering { get; set; } = true;

    /// <summary>
    /// Enable sorting on columns (default: true)
    /// </summary>
    [Parameter]
    public bool AllowSorting { get; set; } = true;

    /// <summary>
    /// Enable pagination (default: true)
    /// </summary>
    [Parameter]
    public bool AllowPaging { get; set; } = true;

    /// <summary>
    /// Enable inline cell editing (default: false)
    /// </summary>
    [Parameter]
    public bool AllowInlineEdit { get; set; } = false;

    /// <summary>
    /// Enable edit button in action column (default: false)
    /// </summary>
    [Parameter]
    public bool AllowEdit { get; set; } = false;

    /// <summary>
    /// Enable delete button in action column (default: false)
    /// </summary>
    [Parameter]
    public bool AllowDelete { get; set; } = false;

    /// <summary>
    /// Show action column with Edit/Delete buttons (default: false)
    /// </summary>
    [Parameter]
    public bool ShowActionColumn { get; set; } = false;

    /// <summary>
    /// Optional column configuration overrides (replaces reflection-based defaults)
    /// </summary>
    [Parameter]
    public IEnumerable<ColumnConfig>? ColumnOverrides { get; set; }

    /// <summary>
    /// Event fired when a row is updated (inline edit mode)
    /// </summary>
    [Parameter]
    public EventCallback<T> OnRowUpdate { get; set; }

    /// <summary>
    /// Event fired when a row is created
    /// </summary>
    [Parameter]
    public EventCallback<T> OnRowCreate { get; set; }

    /// <summary>
    /// Event fired when a row delete is requested
    /// </summary>
    [Parameter]
    public EventCallback<T> OnRowDelete { get; set; }

    /// <summary>
    /// Event fired when edit button is clicked (for modal/edit mode)
    /// </summary>
    [Parameter]
    public EventCallback<T> OnRowEdit { get; set; }

    private RadzenDataGrid<T>? grid;

    /// <summary>
    /// Gets column configuration, either from overrides or reflection
    /// </summary>
    private IEnumerable<ColumnConfig> GetColumnConfig()
    {
        // If explicit overrides provided, use those
        if (ColumnOverrides != null && ColumnOverrides.Any())
        {
            return ColumnOverrides;
        }

        // Otherwise, derive from T's properties using reflection
        try
        {
            return typeof(T).GetProperties(System.Reflection.BindingFlags.Public | System.Reflection.BindingFlags.Instance)
                .Select(p => new ColumnConfig
                {
                    Property = p.Name,
                    DisplayName = p.Name,
                    Sortable = true,
                    Filterable = true,
                    Editable = false,  // Reflection-based defaults to non-editable
                    Hidden = false
                })
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to discover columns for type {TypeName}", typeof(T).Name);
            return Enumerable.Empty<ColumnConfig>();
        }
    }

    /// <summary>
    /// Called by Radzen DataGrid when a row is updated (inline edit mode)
    /// </summary>
    private async Task OnRowUpdated(T row)
    {
        try
        {
            Logger.LogInformation("Row update triggered for {TypeName}", typeof(T).Name);

            if (OnRowUpdate.HasDelegate)
            {
                await OnRowUpdate.InvokeAsync(row);
            }

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = "Record updated successfully",
                Duration = 3000
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating row");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to update record: {ex.Message}",
                Duration = 5000
            });
        }
    }

    /// <summary>
    /// Called by Radzen DataGrid when a new row is created
    /// </summary>
    private async Task OnRowCreated(T row)
    {
        try
        {
            Logger.LogInformation("Row create triggered for {TypeName}", typeof(T).Name);

            if (OnRowCreate.HasDelegate)
            {
                await OnRowCreate.InvokeAsync(row);
            }

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = "Record created successfully",
                Duration = 3000
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating row");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to create record: {ex.Message}",
                Duration = 5000
            });
        }
    }

    /// <summary>
    /// Called when delete button is clicked - requests confirmation first
    /// </summary>
    private async Task OnDeleteRow(T row)
    {
        try
        {
            Logger.LogInformation("Row delete initiated for {TypeName}", typeof(T).Name);

            if (OnRowDelete.HasDelegate)
            {
                await OnRowDelete.InvokeAsync(row);
            }

            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Success",
                Detail = "Record deleted successfully",
                Duration = 3000
            });
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting row");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to delete record: {ex.Message}",
                Duration = 5000
            });
        }
    }

    /// <summary>
    /// Called when edit button is clicked (in non-inline mode)
    /// </summary>
    private async Task OnEditRow(T row)
    {
        try
        {
            Logger.LogInformation("Row edit triggered for {TypeName}", typeof(T).Name);

            if (OnRowEdit.HasDelegate)
            {
                await OnRowEdit.InvokeAsync(row);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error editing row");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to edit record: {ex.Message}",
                Duration = 5000
            });
        }
    }
}
